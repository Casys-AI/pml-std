<story-context id="story-5.2" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>2</storyId>
    <title>Workflow Templates &amp; Graph Bootstrap</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-5.2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>define workflow patterns in a simple YAML file</iWant>
    <soThat>the system can learn my common tool sequences and speculate effectively</soThat>
    <tasks>
      <task id="0" title="Extract Hybrid Search logic (ADR-022 prerequisite)">
        <subtask id="0.1">Add searchToolsHybrid() method to GraphRAGEngine</subtask>
        <subtask id="0.2">Refactor GatewayServer.handleSearchTools to use shared method</subtask>
        <subtask id="0.3">Update DAGSuggester.suggestDAG to use hybrid search</subtask>
        <subtask id="0.4">Add unit tests for searchToolsHybrid</subtask>
      </task>
      <task id="1" title="Define YAML schema and parser" ac="#1,#5">
        <subtask id="1.1">Define TypeScript interface WorkflowTemplate</subtask>
        <subtask id="1.2">Create WorkflowLoader.loadFromYaml(path) using std/yaml</subtask>
        <subtask id="1.3">Validate steps array (min 2 tools per workflow)</subtask>
        <subtask id="1.4">Log warnings for unknown tool IDs</subtask>
      </task>
      <task id="2" title="Implement sync to DB" ac="#2,#3">
        <subtask id="2.1">Convert workflow steps to edges: [A,B,C] → (A→B), (B→C)</subtask>
        <subtask id="2.2">Upsert to tool_dependency table with source='user'</subtask>
        <subtask id="2.3">Set initial confidence: 0.90 for user-defined patterns</subtask>
        <subtask id="2.4">Preserve existing observed_count on upsert</subtask>
      </task>
      <task id="3" title="Create CLI command" ac="#2,#4">
        <subtask id="3.1">Add agentcards workflows sync to CLI</subtask>
        <subtask id="3.2">Store file checksum in DB (adaptive_config table)</subtask>
        <subtask id="3.3">On startup, compare checksum → auto-sync if changed</subtask>
        <subtask id="3.4">Add --force flag to sync even if unchanged</subtask>
      </task>
      <task id="4" title="Bootstrap on empty graph" ac="#6">
        <subtask id="4.1">Check edge count in tool_dependency on startup</subtask>
        <subtask id="4.2">If 0 edges and file exists → auto-run sync</subtask>
        <subtask id="4.3">Log: "Bootstrapping graph from workflow-templates.yaml"</subtask>
      </task>
      <task id="5" title="Add tests" ac="#7">
        <subtask id="5.1">Unit test: YAML parsing with valid/invalid formats</subtask>
        <subtask id="5.2">Unit test: steps → edges conversion</subtask>
        <subtask id="5.3">Integration test: sync creates DB entries with source='user'</subtask>
        <subtask id="5.4">Integration test: auto-bootstrap when graph empty</subtask>
        <subtask id="5.5">Unit test: checksum comparison triggers/skips sync</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1"
    >Simple YAML format in config/workflow-templates.yaml: workflows array with name and steps</criterion>
    <criterion id="2">agentcards workflows sync CLI command imports YAML → DB</criterion>
    <criterion id="3">Entries marked with source='user' in tool_dependency table</criterion>
    <criterion id="4">Auto-sync on startup if file changed (checksum comparison)</criterion>
    <criterion id="5">Validation: unknown tools logged as warnings (not errors)</criterion>
    <criterion id="6">Bootstrap: if graph empty (0 edges), sync runs automatically</criterion>
    <criterion id="7">Tests cover parsing, sync, and bootstrap scenarios</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/adrs/ADR-022-hybrid-search-integration.md</path>
        <title>ADR-022: Hybrid Search Integration in DAG Suggester</title>
        <section>Decision</section>
        <snippet
        >Extract Hybrid Search logic from GatewayServer.handleSearchTools into GraphRAGEngine.searchToolsHybrid(). Replace direct VectorSearch usage in DAGSuggester with hybrid search.</snippet>
      </doc>
      <doc>
        <path>docs/stories/story-5.1.md</path>
        <title>Story 5.1: Search Tools - Semantic + Graph Hybrid</title>
        <section>Technical Design</section>
        <snippet
        >Implements finalScore = α × semanticScore + (1-α) × graphRelatedness. Graph methods: getEdgeCount, getNeighbors, computeAdamicAdar, adamicAdarBetween, computeGraphRelatedness, bootstrapFromTemplates.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-change-proposal-2025-11-26.md</path>
        <title>Sprint Change Proposal: ADR-022</title>
        <section>Detailed Changes</section>
        <snippet
        >5 changes: ADR-022 status, GraphRAGEngine searchToolsHybrid, DAGSuggester modification, GatewayServer refactoring, story-5.2 Task 0 prerequisite.</snippet>
      </doc>
      <doc>
        <path>docs/spikes/spike-search-tools-graph-traversal.md</path>
        <title>Spike: Search Tools Graph Traversal</title>
        <section>Research</section>
        <snippet
        >Adamic-Adar algorithm for link prediction. Adaptive alpha based on graph density.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/graphrag/graph-engine.ts</path>
        <kind>service</kind>
        <symbol>GraphRAGEngine</symbol>
        <lines>34-551</lines>
        <reason
        >Main class to extend with searchToolsHybrid() method. Contains syncFromDatabase(), getEdgeCount(), computeGraphRelatedness(), bootstrapFromTemplates().</reason>
      </file>
      <file>
        <path>src/graphrag/dag-suggester.ts</path>
        <kind>service</kind>
        <symbol>DAGSuggester.suggestDAG</symbol>
        <lines>60-122</lines>
        <reason
        >Method to modify - replace vectorSearch.searchTools() with graphEngine.searchToolsHybrid().</reason>
      </file>
      <file>
        <path>src/mcp/gateway-server.ts</path>
        <kind>handler</kind>
        <symbol>handleSearchTools</symbol>
        <lines>911-1009</lines>
        <reason
        >Contains hybrid search logic (adaptive alpha, graph scoring) to extract and share. Will be refactored to use shared method.</reason>
      </file>
      <file>
        <path>src/vector/search.ts</path>
        <kind>service</kind>
        <symbol>VectorSearch</symbol>
        <reason>Interface for semantic search - will be passed to searchToolsHybrid().</reason>
      </file>
      <file>
        <path>src/graphrag/types.ts</path>
        <kind>types</kind>
        <symbol>WorkflowIntent, SuggestedDAG</symbol>
        <reason>Type definitions used by DAGSuggester.</reason>
      </file>
      <file>
        <path>src/db/migrations/003_graphrag_tables.sql</path>
        <kind>migration</kind>
        <symbol>tool_dependency</symbol>
        <reason>Table schema - may need source column migration.</reason>
      </file>
      <file>
        <path>src/cli/commands.ts</path>
        <kind>cli</kind>
        <symbol>CLI commands</symbol>
        <reason>Add agentcards workflows sync command here.</reason>
      </file>
    </code>

    <dependencies>
      <deno version="2.x">
        <package name="@std/yaml" version="1.0.10">YAML parsing for workflow templates</package>
        <package name="@std/fs" version="1.0.19">File system operations</package>
        <package name="@std/log" version="0.224.14">Logging</package>
        <package name="graphology" version="0.25.4">Graph operations</package>
        <package name="graphology-metrics" version="2.2.0">PageRank, Adamic-Adar</package>
        <package name="@electric-sql/pglite" version="0.3.11">Database</package>
        <package name="@cliffy/command" version="1.0.0-rc.8">CLI framework</package>
      </deno>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>searchToolsHybrid</name>
      <kind>method signature (to create)</kind>
      <signature
      >async searchToolsHybrid(vectorSearch: VectorSearch, query: string, limit?: number, contextTools?: string[]): Promise&lt;HybridSearchResult[]&gt;</signature>
      <path>src/graphrag/graph-engine.ts</path>
    </interface>
    <interface>
      <name>VectorSearch.searchTools</name>
      <kind>method signature (existing)</kind>
      <signature
      >async searchTools(query: string, limit: number, threshold: number): Promise&lt;SearchResult[]&gt;</signature>
      <path>src/vector/search.ts</path>
    </interface>
    <interface>
      <name>GraphRAGEngine.bootstrapFromTemplates</name>
      <kind>method signature (existing)</kind>
      <signature
      >async bootstrapFromTemplates(templates: Record&lt;string, { edges: [string, string][] }&gt;): Promise&lt;void&gt;</signature>
      <path>src/graphrag/graph-engine.ts</path>
    </interface>
    <interface>
      <name>tool_dependency table</name>
      <kind>database schema</kind>
      <signature
      >CREATE TABLE tool_dependency (from_tool_id TEXT, to_tool_id TEXT, observed_count INTEGER, confidence_score REAL, last_observed TIMESTAMP, source TEXT DEFAULT 'learned', PRIMARY KEY (from_tool_id, to_tool_id))</signature>
      <path>src/db/migrations/003_graphrag_tables.sql</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="architecture"
    >Hybrid search logic must be centralized in GraphRAGEngine (ADR-022)</constraint>
    <constraint type="pattern">Use existing Graphology library for graph operations</constraint>
    <constraint type="pattern"
    >Follow PGlite for persistence, Graphology for computation pattern</constraint>
    <constraint type="performance">searchToolsHybrid &lt;20ms overhead (ADR-022)</constraint>
    <constraint type="graceful-degradation"
    >Falls back to semantic-only if graph is empty (alpha=1.0)</constraint>
    <constraint type="db-migration"
    >Need source column in tool_dependency if not present</constraint>
    <constraint type="yaml-format"
    >Simple format: workflows array with name + steps only - no confidence/parallel flags</constraint>
  </constraints>

  <tests>
    <standards
    >
      Deno test framework with @std/assert. Unit tests in tests/unit/, integration in tests/integration/.
      Mock database with PGliteClient("memory://"). Run migrations before tests.
      Test naming: [module]_test.ts. Use Deno.test() with descriptive names.
    </standards>
    <locations>
      <location>tests/unit/graphrag/graph_engine_test.ts</location>
      <location>tests/unit/graphrag/dag_suggester_test.ts</location>
      <location>tests/unit/graphrag/search_tools_test.ts</location>
      <location>tests/integration/ (for CLI and bootstrap tests)</location>
    </locations>
    <ideas>
      <idea ac="#0">Test searchToolsHybrid returns combined semantic+graph scores</idea>
      <idea ac="#0">Test adaptive alpha calculation based on edge count</idea>
      <idea ac="#0">Test DAGSuggester uses hybrid search instead of direct vector</idea>
      <idea ac="#1">Test YAML parsing with valid workflow format</idea>
      <idea ac="#1">Test YAML validation rejects invalid formats (missing steps, &lt;2 tools)</idea>
      <idea ac="#5">Test unknown tools logged as warnings not errors</idea>
      <idea ac="#2,#3">Test edges created with source='user' in DB</idea>
      <idea ac="#4">Test checksum comparison triggers/skips sync</idea>
      <idea ac="#6">Test bootstrap runs when graph has 0 edges</idea>
    </ideas>
  </tests>
</story-context>
