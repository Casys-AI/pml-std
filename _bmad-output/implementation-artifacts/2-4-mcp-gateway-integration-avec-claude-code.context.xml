<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.4</storyId>
    <title>MCP Gateway Integration avec Claude Code</title>
    <status>drafted</status>
    <generatedAt>2025-11-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-2.4.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Claude Code user</asA>
    <iWant>Casys Intelligence to act as a transparent MCP gateway</iWant>
    <soThat>Claude can interact with all my MCP servers via a single entry point</soThat>
    <tasks
    >
      - MCP server implementation working
      - stdio transport integrated
      - list_tools handler functional
      - call_tool handler functional (single + workflow)
      - Transparent proxying to underlying MCP servers
      - MCP-compliant error responses
      - `agentcards serve` CLI command working
      - Integration tests passing
      - Documentation for Claude Code setup
    </tasks>
  </story>

  <acceptanceCriteria
  >
    1. MCP protocol server implementation (stdio mode primary)
    2. Casys Intelligence expose MCP server interface compatible avec Claude Code
    3. Requests de Claude interceptés par gateway
    4. Vector search → load schemas → execute tools → return results
    5. Transparent proxying: Claude voit Casys Intelligence comme un seul MCP server
    6. Support `list_tools`, `call_tool`, `get_prompt` methods (MCP spec)
    7. Error handling: MCP-compliant error responses
    8. Integration test avec mock Claude client
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Casys Intelligence Product Requirements Document</title>
        <section>Functional Requirements - DAG Execution &amp; Orchestration</section>
        <snippet
        >FR005-FR008 define DAG execution requirements: analyze dependencies, identify parallel execution, execute simultaneous branches, and stream results via SSE. NFR001 targets P95 latency &lt;3s for 5-tool workflows (5x improvement).</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Casys Intelligence Product Requirements Document</title>
        <section>MCP Server Management</section>
        <snippet
        >FR009-FR011 specify auto-discovery of MCP servers (stdio/SSE), automatic health checks at startup, and support for 15+ concurrent servers without performance degradation.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - Casys Intelligence</title>
        <section>Project Structure - MCP Module</section>
        <snippet
        >MCP module structure: discovery.ts (Story 1.3), client.ts (SDK wrapper), gateway.ts (Story 2.4), types.ts. Gateway server is designated for Story 2.4 with stdin/stdout transport.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - Casys Intelligence</title>
        <section>MCP Protocol Decision</section>
        <snippet
        >Using @modelcontextprotocol/sdk (official TypeScript SDK, 10.5k stars) with stdio + SSE transport support for Epic 1 and Epic 2.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - Casys Intelligence</title>
        <section>CLI Framework</section>
        <snippet
        >Using cliffy for type-safe args parsing, auto-help, shell completions. CLI commands include init, serve (Story 2.4), and status.</snippet>
      </doc>
      <doc>
        <path>docs/stories/story-2.4.md</path>
        <title>Story 2.4 Technical Notes</title>
        <section>MCP Server Implementation Example</section>
        <snippet
        >Complete implementation example showing Casys IntelligenceGateway class with Server from @modelcontextprotocol/sdk, handlers for list_tools, call_tool, get_prompt, and StdioServerTransport setup.</snippet>
      </doc>
      <doc>
        <path>docs/stories/story-2.4.md</path>
        <title>Story 2.4 Configuration</title>
        <section>Claude Code Integration</section>
        <snippet
        >Claude Desktop configuration at ~/.config/Claude/claude_desktop_config.json requires single entry: "agentcards" with command "agentcards" and args ["serve"].</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/mcp/gateway-handler.ts</path>
        <kind>service</kind>
        <symbol>GatewayHandler</symbol>
        <lines>1-332</lines>
        <reason
        >Existing gateway handler with processIntent(), executeDAG(), safety checks, and adaptive thresholds. Can be wrapped by MCP Server to expose via stdio protocol.</reason>
      </artifact>
      <artifact>
        <path>src/mcp/types.ts</path>
        <kind>types</kind>
        <symbol>MCPServer, MCPTool, MCPConfig</symbol>
        <lines>1-60</lines>
        <reason
        >Core MCP type definitions for servers, tools, and configuration that gateway will expose via MCP protocol.</reason>
      </artifact>
      <artifact>
        <path>src/mcp/client.ts</path>
        <kind>service</kind>
        <symbol>MCPClient</symbol>
        <lines>full file</lines>
        <reason
        >MCP client wrapper for connecting to and calling underlying MCP servers. Gateway will use this to proxy tool calls.</reason>
      </artifact>
      <artifact>
        <path>src/dag/executor.ts</path>
        <kind>service</kind>
        <symbol>ParallelExecutor</symbol>
        <lines>1-432</lines>
        <reason
        >DAG execution engine with topological sort, parallel execution, and $OUTPUT resolution. Gateway's execute_workflow will use this.</reason>
      </artifact>
      <artifact>
        <path>src/vector/search.ts</path>
        <kind>service</kind>
        <symbol>VectorSearch</symbol>
        <lines>1-138</lines>
        <reason
        >Semantic vector search with searchTools() method. Used by gateway's list_tools handler to find relevant tools based on query context.</reason>
      </artifact>
      <artifact>
        <path>src/server/sse-handler.ts</path>
        <kind>service</kind>
        <symbol>SSEStreamHandler</symbol>
        <lines>full file</lines>
        <reason
        >SSE streaming implementation for progressive results. Gateway may use this for streaming execution results.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/mcp/gateway_handler_test.ts</path>
        <kind>test</kind>
        <symbol>GatewayHandler tests</symbol>
        <lines>full file</lines>
        <reason
        >Existing test patterns for gateway handler. Reference for testing patterns and mock setup.</reason>
      </artifact>
      <artifact>
        <path>src/cli/commands/init.ts</path>
        <kind>command</kind>
        <symbol>init command</symbol>
        <lines>full file</lines>
        <reason
        >Example CLI command pattern with cliffy. Reference for implementing 'serve' command.</reason>
      </artifact>
    </code>
    <dependencies>
      <deno>
        <package>@cliffy/command</package>
        <version>1.0.0-rc.7</version>
        <usage>CLI framework for serve command</usage>
      </deno>
      <npm>
        <package>@electric-sql/pglite</package>
        <version>0.3.11</version>
        <usage>Database access for schema loading and context optimization</usage>
      </npm>
      <npm>
        <package>@modelcontextprotocol/sdk</package>
        <version>latest</version>
        <usage
        >Official MCP SDK - Server, StdioServerTransport, protocol types (REQUIRED for this story)</usage>
      </npm>
    </dependencies>
  </artifacts>

  <constraints
  >
    - Must implement MCP protocol specification exactly (see https://modelcontextprotocol.io/docs/specification)
    - stdio transport is PRIMARY mode (SSE is secondary/optional)
    - Error responses must follow JSON-RPC 2.0 error codes: -32700 (parse), -32600 (invalid request), -32601 (method not found), -32602 (invalid params), -32603 (internal error)
    - Gateway must be transparent: Claude sees single MCP server, not individual underlying servers
    - Tool names should follow pattern: "serverId:toolName" for proxying OR "agentcards:workflow" for DAG execution
    - Must support MCP methods: tools/list, tools/call, prompts/get (optional)
    - list_tools should use semantic search when query context provided, return all tools otherwise (with warning)
    - call_tool must support both single tool proxy AND workflow execution (agentcards:execute_workflow)
    - Configuration must be compatible with Claude Desktop config format
    - Must use existing GatewayHandler, VectorSearch, ParallelExecutor - DO NOT reimplement
  </constraints>

  <interfaces>
    <interface>
      <name>Server (from @modelcontextprotocol/sdk)</name>
      <kind>MCP SDK Class</kind>
      <signature
      >
        new Server(info: { name: string; version: string }, capabilities: { tools?: {}, prompts?: {} })
        .setRequestHandler(method: string, handler: (request) => Promise&lt;any&gt;)
        .connect(transport: StdioServerTransport): Promise&lt;void&gt;
      </signature>
      <path>npm:@modelcontextprotocol/sdk/server/index.js</path>
    </interface>
    <interface>
      <name>StdioServerTransport (from @modelcontextprotocol/sdk)</name>
      <kind>MCP SDK Class</kind>
      <signature>new StdioServerTransport() - Creates stdio transport for Server</signature>
      <path>npm:@modelcontextprotocol/sdk/server/stdio.js</path>
    </interface>
    <interface>
      <name>GatewayHandler.processIntent()</name>
      <kind>method</kind>
      <signature
      >async processIntent(intent: WorkflowIntent): Promise&lt;ExecutionMode&gt;</signature>
      <path>src/mcp/gateway-handler.ts:91-187</path>
    </interface>
    <interface>
      <name>VectorSearch.searchTools()</name>
      <kind>method</kind>
      <signature
      >async searchTools(query: string, topK?: number, minScore?: number): Promise&lt;SearchResult[]&gt;</signature>
      <path>src/vector/search.ts:53-136</path>
    </interface>
    <interface>
      <name>ParallelExecutor.execute()</name>
      <kind>method</kind>
      <signature>async execute(dag: DAGStructure): Promise&lt;DAGExecutionResult&gt;</signature>
      <path>src/dag/executor.ts:59-156</path>
    </interface>
  </interfaces>

  <tests>
    <standards
    >
      Use Deno.test for all tests. Unit tests go in tests/unit/, integration tests in tests/integration/. Mock external dependencies (MCP servers, file I/O). Use @std/assert for assertions. Follow existing patterns from tests/unit/mcp/gateway_handler_test.ts and tests/integration/dag_execution_e2e_test.ts.
    </standards>
    <locations
    >
      - tests/unit/mcp/ - Unit tests for MCP gateway
      - tests/integration/ - E2E integration tests
    </locations>
    <ideas>
      <test id="AC1">
        <name>MCP server initialization with stdio transport</name>
        <acceptance_criteria>AC1</acceptance_criteria>
        <description
        >Test that Server and StdioServerTransport are properly initialized with correct capabilities</description>
      </test>
      <test id="AC6">
        <name>Handler: tools/list without query context</name>
        <acceptance_criteria>AC6</acceptance_criteria>
        <description
        >Verify list_tools handler returns all available tools when no query provided</description>
      </test>
      <test id="AC6">
        <name>Handler: tools/list with semantic query</name>
        <acceptance_criteria>AC4, AC6</acceptance_criteria>
        <description
        >Verify list_tools uses VectorSearch.searchTools() when query context provided</description>
      </test>
      <test id="AC6">
        <name>Handler: tools/call for single tool proxy</name>
        <acceptance_criteria>AC3, AC5, AC6</acceptance_criteria>
        <description
        >Test call_tool proxying to underlying MCP server (e.g., "filesystem:read")</description>
      </test>
      <test id="AC6">
        <name>Handler: tools/call for workflow execution</name>
        <acceptance_criteria>AC4, AC6</acceptance_criteria>
        <description>Test agentcards:execute_workflow using ParallelExecutor</description>
      </test>
      <test id="AC7">
        <name>MCP-compliant error responses</name>
        <acceptance_criteria>AC7</acceptance_criteria>
        <description
        >Verify error responses follow JSON-RPC 2.0 format with correct error codes</description>
      </test>
      <test id="AC8">
        <name>Integration test with mock Claude client</name>
        <acceptance_criteria>AC2, AC8</acceptance_criteria>
        <description>E2E test simulating Claude Code calling gateway via stdio</description>
      </test>
      <test id="CLI">
        <name>agentcards serve command</name>
        <acceptance_criteria>DoD</acceptance_criteria>
        <description>Test CLI command starts gateway server successfully</description>
      </test>
    </ideas>
  </tests>
</story-context>
