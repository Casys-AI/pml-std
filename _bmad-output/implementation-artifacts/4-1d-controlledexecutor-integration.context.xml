<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>1d</storyId>
    <title>ControlledExecutor Integration</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-1d-controlledexecutor-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>workflow execution system</asA>
    <iWant>capture episodic events automatically during execution</iWant>
    <soThat>learning happens without manual instrumentation</soThat>
    <tasks>
      <task id="1" title="Add EpisodicMemoryStore dependency to ControlledExecutor" ac="#1">
        <subtask id="1.1">Add setEpisodicMemoryStore(store: EpisodicMemoryStore) method</subtask>
        <subtask id="1.2"
        >Store reference as private field private episodicMemory: EpisodicMemoryStore | null</subtask>
        <subtask id="1.3">Make episodic memory optional (graceful degradation if not set)</subtask>
      </task>
      <task id="2" title="Capture task_complete events" ac="#2,#3">
        <subtask id="2.1"
        >In executeTask() method, after task completion, call episodicMemory.capture()</subtask>
        <subtask id="2.2"
        >Include event data: workflow_id, task_id, timestamp, result.status, executionTimeMs</subtask>
        <subtask id="2.3">Include context hash from current workflow state</subtask>
        <subtask id="2.4">Handle both successful and failed tasks</subtask>
      </task>
      <task id="3" title="Capture ail_decision events" ac="#2,#3">
        <subtask id="3.1"
        >In AIL decision point (after waitForDecisionCommand), capture decision event</subtask>
        <subtask id="3.2">Include decision data: decision_type: 'AIL', outcome, reasoning</subtask>
        <subtask id="3.3"
        >Include context at decision point (completed tasks, current layer)</subtask>
      </task>
      <task id="4" title="Capture hil_decision events" ac="#2,#3">
        <subtask id="4.1">In HIL approval checkpoint, capture decision event</subtask>
        <subtask id="4.2">Include approval data: decision_type: 'HIL', approved, feedback</subtask>
        <subtask id="4.3">Include context and checkpoint_id</subtask>
      </task>
      <task id="5" title="Add speculation_start event support" ac="#2">
        <subtask id="5.1"
        >Create capture point for when speculation begins (placeholder for Epic 3.5)</subtask>
        <subtask id="5.2">Include prediction data: toolId, confidence, reasoning</subtask>
        <subtask id="5.3">Add was_correct field to be updated after speculation validation</subtask>
      </task>
      <task id="6" title="Performance validation" ac="#5">
        <subtask id="6.1">Add benchmark test for event capture overhead</subtask>
        <subtask id="6.2"
        >Verify less than 1ms per capture call (non-blocking, buffered writes)</subtask>
        <subtask id="6.3">Test with high-volume workflows (100+ tasks)</subtask>
      </task>
      <task id="7" title="Integration tests" ac="#4,#6">
        <subtask id="7.1">Test: Execute workflow - verify task_complete events captured</subtask>
        <subtask id="7.2"
        >Test: AIL decision - verify ail_decision event captured with correct context</subtask>
        <subtask id="7.3">Test: HIL approval - verify hil_decision event captured</subtask>
        <subtask id="7.4">Test: Graceful degradation when EpisodicMemoryStore not set</subtask>
        <subtask id="7.5">Test: Event metadata includes all required fields</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">ControlledExecutor emits events to EpisodicMemoryStore</criterion>
    <criterion id="2"
    >Events captured: speculation_start, task_complete, ail_decision, hil_decision</criterion>
    <criterion id="3">Context captured at each decision point (workflow context hash)</criterion>
    <criterion id="4">Integration tests verify auto-capture works</criterion>
    <criterion id="5"
    >Zero performance impact on Loop 1 (less than 1ms overhead per event capture)</criterion>
    <criterion id="6"
    >Events include workflow_id, task_id, timestamp, and relevant metadata</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc
        path="docs/adrs/ADR-008-episodic-memory-adaptive-thresholds.md"
        title="ADR-008: Episodic Memory &amp; Adaptive Thresholds"
      >
        <section>Phase 1 &amp; 2 Implementation</section>
        <snippet
        >Phase 1 (Storage Foundation) DONE. Phase 2 (Loop Integrations) Backlog: ControlledExecutor integration (auto-capture events), DAGSuggester context boost.</snippet>
      </doc>
      <doc
        path="docs/adrs/ADR-007-dag-adaptive-feedback-loops.md"
        title="ADR-007: DAG Adaptive Feedback Loops"
      >
        <section>3-Loop Learning Architecture</section>
        <snippet
        >Loop 1 (Execution), Loop 2 (Adaptation), Loop 3 (Meta-Learning). ControlledExecutor is the core of Loop 1-2.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Decision Architecture - Casys Intelligence">
        <section>Project Structure - src/dag/, src/learning/</section>
        <snippet
        >controlled-executor.ts (Story 2.5-1 - Adaptive executor), learning/ module for episodic memory storage.</snippet>
      </doc>
      <doc path="docs/tech-spec-epic-2.5.md" title="Epic 2.5 Technical Specification">
        <section>ControlledExecutor Architecture</section>
        <snippet
        >Event stream for real-time observability, command queue for dynamic control, WorkflowState management with reducers.</snippet>
      </doc>
      <doc path="docs/epics.md" title="Epics &amp; Stories">
        <section>Epic 4: Episodic Memory &amp; Adaptive Learning</section>
        <snippet
        >Story 4.1d: ControlledExecutor Integration - Auto-capture events during execution for learning.</snippet>
      </doc>
    </docs>
    <code>
      <artifact
        path="src/dag/controlled-executor.ts"
        kind="executor"
        symbol="ControlledExecutor"
        lines="63-1252"
      >
        <reason
        >Primary integration target. Extends ParallelExecutor with event stream, command queue, AIL/HIL decision points. Need to add EpisodicMemoryStore capture calls.</reason>
      </artifact>
      <artifact
        path="src/learning/episodic-memory-store.ts"
        kind="store"
        symbol="EpisodicMemoryStore"
        lines="1-395"
      >
        <reason
        >Storage layer already implemented (Phase 1). Key methods: capture(), flush(), retrieveRelevant(). Non-blocking writes with buffer.</reason>
      </artifact>
      <artifact
        path="src/learning/types.ts"
        kind="types"
        symbol="EpisodicEvent, EpisodicEventType"
        lines="1-127"
      >
        <reason
        >Type definitions for episodic events. EpisodicEventType includes speculation_start, task_complete, ail_decision, hil_decision.</reason>
      </artifact>
      <artifact path="src/dag/event-stream.ts" kind="stream" symbol="EventStream" lines="full">
        <reason
        >Event streaming infrastructure used by ControlledExecutor. Pattern to follow for episodic event emission.</reason>
      </artifact>
      <artifact
        path="src/dag/state.ts"
        kind="state"
        symbol="WorkflowState, StateUpdate"
        lines="full"
      >
        <reason
        >State management with reducers. Context hash may be derived from WorkflowState for episodic events.</reason>
      </artifact>
      <artifact path="src/dag/command-queue.ts" kind="queue" symbol="CommandQueue" lines="full">
        <reason
        >Command processing for AIL/HIL decisions. Decision events should be captured here.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem type="deno">
        <package name="@std/assert" version="1.0.11" />
        <package name="@std/log" version="0.224.14" />
        <package name="@electric-sql/pglite" version="0.3.11" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance"
    >Event capture overhead must be less than 1ms per call (AC #5)</constraint>
    <constraint type="performance"
    >Non-blocking buffered writes - no blocking on Loop 1 execution</constraint>
    <constraint type="compatibility"
    >Zero breaking changes to existing ControlledExecutor API</constraint>
    <constraint type="architecture"
    >EpisodicMemoryStore dependency is optional (graceful degradation)</constraint>
    <constraint type="data"
    >No PII (outputs/arguments content). Enriched metadata allowed: output_size, output_type, tool_category, error_code</constraint>
    <constraint type="testing">Existing ControlledExecutor tests must continue passing</constraint>
  </constraints>

  <interfaces>
    <interface
      name="EpisodicMemoryStore.capture"
      kind="method"
      path="src/learning/episodic-memory-store.ts"
    >
      <signature>async capture(event: EpisodicEventInput): Promise&lt;string&gt;</signature>
    </interface>
    <interface
      name="ControlledExecutor.setEpisodicMemoryStore"
      kind="method"
      path="src/dag/controlled-executor.ts"
    >
      <signature>setEpisodicMemoryStore(store: EpisodicMemoryStore): void (TO BE ADDED)</signature>
    </interface>
    <interface name="EpisodicEventInput" kind="type" path="src/learning/types.ts">
      <signature
      >{ workflow_id: string; event_type: EpisodicEventType; task_id?: string; timestamp: number; data: EpisodicEventData }</signature>
    </interface>
    <interface name="EpisodicEventType" kind="type" path="src/learning/types.ts">
      <signature
      >"speculation_start" | "task_complete" | "ail_decision" | "hil_decision" | "workflow_start" | "workflow_complete"</signature>
    </interface>
  </interfaces>

  <tests>
    <standards
    >
      Deno.test native framework with @std/assert. Tests in tests/unit/ (unit) and tests/integration/ (e2e).
      Test pattern: Mock EpisodicMemoryStore with spy on capture() method. Verify events captured with correct structure.
      Existing tests: 9 tests passing for EpisodicMemoryStore (tests/unit/learning/episodic_memory_store_test.ts).
    </standards>
    <locations>
      <location pattern="tests/unit/dag/controlled_executor_test.ts" />
      <location pattern="tests/unit/learning/episodic_memory_store_test.ts" />
      <location pattern="tests/integration/dag/*_test.ts" />
      <location pattern="tests/e2e/controlled_executor_*.ts" />
    </locations>
    <ideas>
      <test-idea ac="1,6"
      >Test: Execute workflow with EpisodicMemoryStore set → verify task_complete events captured with workflow_id, task_id, timestamp</test-idea>
      <test-idea ac="2,3"
      >Test: AIL decision point → verify ail_decision event captured with correct context (completed tasks, current layer)</test-idea>
      <test-idea ac="2,3"
      >Test: HIL approval checkpoint → verify hil_decision event captured with approval data</test-idea>
      <test-idea ac="4"
      >Test: Graceful degradation when EpisodicMemoryStore not set → no errors, workflow completes normally</test-idea>
      <test-idea ac="5"
      >Test: Benchmark event capture overhead → verify less than 1ms per capture call with 100+ task workflow</test-idea>
      <test-idea ac="5"
      >Test: Non-blocking verification → workflow execution time not significantly impacted by event capture</test-idea>
      <test-idea ac="2"
      >Test: speculation_start event placeholder (for Epic 3.5) → structure validated, event type accepted</test-idea>
    </ideas>
  </tests>
</story-context>
